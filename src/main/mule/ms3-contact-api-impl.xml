<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	
	<sub-flow name="insert-contact" doc:id="389e4277-845a-4945-a115-95c429b6c1f5">
		<logger level="INFO" doc:name="Logger" doc:id="fb10b50f-6e3d-497b-8914-9336a04a0aa4" message="#['Insert Contact Request Payload: ' ++ write(payload, 'application/json')]" />
		<set-variable value="#[payload]" doc:name="originalPayload" doc:id="59d8ae94-6521-4d0b-98e2-dba80a3a14c3" variableName="originalPayload"/>
		<db:insert doc:name="Insert Identification table" doc:id="db6a4797-54e3-4870-ae55-058cb9d1e5d0" config-ref="Database_Config" autoGenerateKeys="true" autoGeneratedKeysColumnNames="#[['IdentiRefId']]">
			<db:sql>INSERT INTO Identification (FirstName, LastName, DOB, Gender, Title) 
values(:firstName,:lastName,:dob,:gender,:title)</db:sql>
			<db:input-parameters><![CDATA[#[{
firstName: payload.identification.firstName,
lastName: payload.identification.lastName,
dob: payload.identification.dob,
gender: payload.identification.gender,
title: payload.identification.title
}]]]></db:input-parameters>

		</db:insert>
		<set-variable variableName="contactId" value="#[payload.generatedKeys['GENERATED_KEY'] as String]" doc:name="contactId"/>
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="18b888a5-1594-41ee-b052-733a6257ccd5">
            <ee:message>
            </ee:message>
			<ee:variables>
				<ee:set-variable variableName="addressParam"><![CDATA[%dw 2.0
output application/java
---
vars.originalPayload.address map {
	 "contactId": vars.contactId,
	 "type": $.'type',
     "number": $.'number',
     "street": $.'street',
     "unit": $.'unit',
     "city": $.'city',
     "state": $.'state',
     "zipCode": $.'zipCode'
}]]></ee:set-variable>
				<ee:set-variable variableName="communicationParam"><![CDATA[%dw 2.0
output application/java
---
vars.originalPayload.communication map {
	 "contactId": vars.contactId,
	 "type": $.'type',
     "value": $.'value',
     "preferred": $.'preferred'
}]]></ee:set-variable>
			</ee:variables>
        </ee:transform>
		<db:bulk-insert doc:name="Bulk insert addres table" doc:id="a1500e9f-563a-49e4-bd86-6993a8f8eabc" config-ref="Database_Config">
			<db:bulk-input-parameters ><![CDATA[#[vars.addressParam]]]></db:bulk-input-parameters>
			<db:sql >INSERT INTO Address (ContactId, Type, Number, Street, Unit, City, State, Zipcode) values (:contactId, :type, :number, :street, :unit, :city, :state, :zipCode)</db:sql>
		</db:bulk-insert>
		<db:bulk-insert doc:name="Bulk insert communication table" doc:id="f066bbe3-5ce0-48e8-bcef-088256c075ca" config-ref="Database_Config">
			<db:bulk-input-parameters ><![CDATA[#[vars.communicationParam]]]></db:bulk-input-parameters>
			<db:sql >INSERT INTO Communication (ContactId, Type, Value, Preferred) values (:contactId, :type, :value, :preferred)</db:sql>
		</db:bulk-insert>
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="72d152a7-2031-43a7-a651-07e0d35baa9a">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  code: "201",
  message: "Record Inserted successfully"
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="ab67c8c9-44d1-4f74-9e8d-d3e5fad8dc06" message="#[payload]" />
	</sub-flow>
	<sub-flow name="retrieve-contact" doc:id="a9b9b996-b58a-47b1-9e47-1ee65ca6b1ec">
		<logger level="INFO" doc:name="Logger" doc:id="fb1e2f13-1801-4e89-b926-b5ff5069bbd9" message="#['Retrieve contact details for lastName: ' ++ attributes.queryParams.lastName ++ 'Date of Birth: ' ++ attributes.queryParams.dob]"/>
		<ee:transform doc:name="Transform Message" doc:id="4aa2a343-b5d5-44ad-8f58-6c8b9f7dd574" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="lastName" ><![CDATA[attributes.queryParams.'lastName']]></ee:set-variable>
				<ee:set-variable variableName="dob" ><![CDATA[attributes.queryParams.'dob']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<db:select doc:name="Select Contact Deatils" doc:id="6cc141a0-fa7f-4ec3-b4b8-dabf3b166bb7" config-ref="Database_Config">
			<db:sql>SELECT identi.FirstName as firstName, identi.LastName as lastName, identi.DOB as dob, 
identi.Gender as gender, identi.Title as title, addr.Type as addressType, addr.Number as addressNumber, 
addr.Street as addressStreet, addr.Unit as addressUnit, addr.City as addressCity, 
addr.State as addressState, addr.Zipcode as addressZip, comm.Type as commType, comm.Value as commValue, 
comm.Preferred as commPreferred 
FROM Identification identi, Address addr, Communication comm 
where identi.ContactId = addr.ContactId 
and identi.ContactId = comm.ContactId 
and identi.LastName = :lastName 
and identi.DOB = :dob </db:sql>
			<db:input-parameters ><![CDATA[#[{
 	lastName: vars.lastName,
 	dob: vars.dob
}]]]></db:input-parameters>
		</db:select>
		<choice doc:name="Choice" doc:id="698cec9c-1f34-4a82-b456-9a156a036016" >
			<when expression="#[payload[0].lastName == null]">
				<ee:transform doc:name="Transform Message" doc:id="1985c33f-4070-4cab-a74e-0d86cc6e114d" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/Json
---
{message: "No Record found for given LastName and DOB"}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[200]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</when>
			<otherwise >
				<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="ab191f23-d204-46fc-bb03-37883d906b29">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  identification: {
    firstName: payload[0].firstName,
    lastName: payload[0].lastName,
    dob: payload[0].dob,
    gender: payload[0].gender,
    title: payload[0].title
  },
  address: payload map {
     "type ": $.addressType,
      number: $.addressNumber,
      street: $.addressStreet,
      unit: $.addressUnit,
      city: $.addressCity,
      state: $.addressState,
      zipCode: $.addressZip
    } distinctBy $,
  communication: payload map {
      "type": $.commType,
      value: $.commValue,
      preferred: $.commPreferred
    } distinctBy $
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Logger" doc:id="1ee2f7c0-2e4d-4268-917a-70790fc5a5be" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="update-contact" doc:id="8e2ecb0d-6699-4023-89ef-71ef13337f52" >
		<logger level="INFO" doc:name="Logger" doc:id="25abd225-8532-4ab3-b603-68f2d353a7d2" message="#['Update Contact Request Payload: ' ++ write(payload, 'application/json')]"/>
		<set-variable value="#[payload]" doc:name="originalPayload" doc:id="9509c6ed-0588-4988-b1f8-22db39aaeaf4" variableName="originalPayload"/>
		<db:select doc:name="Identification table" doc:id="ef8c8aa3-c928-4324-b76f-dec93b11814e" config-ref="Database_Config">
			<db:sql >SELECT contactId from Identification where LastName = :lastName and DOB = :dob </db:sql>
			<db:input-parameters ><![CDATA[#[{
 	lastName: payload.identification.lastName,
 	dob: payload.identification.dob
}]]]></db:input-parameters>
		</db:select>
		<choice doc:name="Choice" doc:id="a85d1e3b-4f3a-4b25-84d4-6fc3fc796f98" >
			<when expression="#[payload.contactId[0] == null]">
				<ee:transform doc:name="Transform Message" doc:id="e982c645-d9ee-45f4-b81d-5b170bd08003" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/Json
---
{message: "No Record found for Updating with given LastName and DOB"}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[200]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</when>
			<otherwise >
				<set-variable value="#[payload.contactId[0]]" doc:name="contactId" doc:id="eb8e4fcf-899e-428e-8afb-0957d8bb3db0" variableName="contactId" />
				<db:update doc:name="Update Identification table" doc:id="67a082d7-9484-47f4-b29e-f3771d08bd70" config-ref="Database_Config">
			<db:sql>UPDATE Identification SET FirstName = :firstName, LastName = :lastName, DOB = :dob, Gender = :gender, Title = :title where ContactId = :contactId</db:sql>
			<db:input-parameters><![CDATA[#[{
contactId: vars.contactId,
firstName: vars.originalPayload.identification.firstName,
lastName: vars.originalPayload.identification.lastName,
dob: vars.originalPayload.identification.dob,
gender: vars.originalPayload.identification.gender,
title: vars.originalPayload.identification.title
}]]]></db:input-parameters>
		</db:update>
				<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="abbe35ad-b70d-42d3-ac01-d789a8135329">
            <ee:message>
            </ee:message>
			<ee:variables>
				<ee:set-variable variableName="addressParam"><![CDATA[%dw 2.0
output application/java
---
vars.originalPayload.address map {
	 "contactId": vars.contactId,
	 "type": $.'type',
     "number": $.'number',
     "street": $.'street',
     "unit": $.'unit',
     "city": $.'city',
     "state": $.'state',
     "zipCode": $.'zipCode'
}]]></ee:set-variable>
				<ee:set-variable variableName="communicationParam"><![CDATA[%dw 2.0
output application/java
---
vars.originalPayload.communication map {
	 "contactId": vars.contactId,
	 "type": $.'type',
     "value": $.'value',
     "preferred": $.'preferred'
}]]></ee:set-variable>
			</ee:variables>
        </ee:transform>
				<db:bulk-update doc:name="update Address table" doc:id="3db3aa3d-dd1b-4e37-a5dd-f32042e1bca0" config-ref="Database_Config">
			<db:bulk-input-parameters><![CDATA[#[vars.addressParam]]]></db:bulk-input-parameters>
			<db:sql>UPDATE Address SET Type = :type, Number = :number, Street = :street, Unit = :unit, City = :city, State = :state, Zipcode = :zipCode where ContactId = :contactId</db:sql>
		</db:bulk-update>
				<db:bulk-update doc:name="update Communication table" doc:id="a8922d80-3a7b-4572-ba15-d1ff319e53ba" config-ref="Database_Config">
			<db:bulk-input-parameters><![CDATA[#[vars.communicationParam]]]></db:bulk-input-parameters>
			<db:sql>UPDATE Communication SET Type = :type, Value = :value, Preferred = :preferred where ContactId = :contactId</db:sql>
		</db:bulk-update>
				<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="f45c1348-0ce3-4766-9c9b-a15c0f9174ab">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  code: "201",
  message: "Record Updated successfully"
}]]></ee:set-payload>
            </ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[201]]></ee:set-variable>
					</ee:variables>
        </ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Logger" doc:id="3fd38aec-cede-46a6-82f5-26438f038a08" message="#[payload]" />
	</sub-flow>
	<sub-flow name="delete-contact" doc:id="3d7e4833-4f28-4faa-8a55-14d387d246ac" >
		<logger level="INFO" doc:name="Logger" doc:id="b51a1c5d-be46-47d9-a595-5eb676ed8eff" message="#['Delete contact details for lastName: ' ++ attributes.queryParams.lastName ++ 'Date of Birth: ' ++ attributes.queryParams.dob]"/>
		<ee:transform doc:name="Transform Message" doc:id="38a7964c-7cf0-43e0-a793-f1f1c1a95500" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="lastName" ><![CDATA[attributes.queryParams.'lastName']]></ee:set-variable>
				<ee:set-variable variableName="dob" ><![CDATA[attributes.queryParams.'dob']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<db:select doc:name="Identification table" doc:id="8014847a-04e7-42ef-bd37-c4ac3bde335b" config-ref="Database_Config">
			<db:sql >SELECT contactId from Identification where LastName = :lastName and DOB = :dob </db:sql>
			<db:input-parameters ><![CDATA[#[{
 	lastName: vars.lastName,
 	dob: vars.dob
}]]]></db:input-parameters>
		</db:select>
		<choice doc:name="Choice" doc:id="a52a4073-8f1b-42f5-bbf6-cbd284eb1e9e" >
			<when expression="#[payload.contactId[0] == null]">
				<ee:transform doc:name="Transform Message" doc:id="417fb545-2190-4b3f-b685-058a8bd13804" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/Json
---
{message: "No Record found for delete for given LastName and DOB"}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[200]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</when>
			<otherwise >
				<set-variable value="#[payload.contactId[0] as Number]" doc:name="contactId" doc:id="890603aa-111e-4574-8781-3019ee4a1b3b" variableName="contactId" />
				<db:delete doc:name="Delete Identification table" doc:id="41e41da3-33cc-4ffa-86e5-580d60e18d2d" config-ref="Database_Config">
			<db:sql>DELETE Identification, Address, Communication FROM Address, Identification, Communication
WHERE Identification.ContactId = :contactId
AND Identification.ContactId = Address.ContactId
AND Identification.ContactId = Communication.ContactId
</db:sql>
			<db:input-parameters><![CDATA[#[{
	contactId: vars.contactId
}]]]></db:input-parameters>
		</db:delete>
				<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="ba29b1b9-8f95-4ff5-bc89-82f022953774">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  message: "Record Deleted Successfully"
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Logger" doc:id="2ddd4757-5d83-45d9-afe8-19e4351003f8" message="#[payload]" />
	</sub-flow>
</mule>
